<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">

	<flow name="collector-apim-metrics-parallel-flow" doc:id="c4b43d89-a5f8-4582-8f1a-2296b79d60c6">
		<parallel-foreach doc:name="Parallel For Each" doc:id="1f93fa99-2026-45b6-bcac-29ddb3799db8" collection="#[vars.environments]">
			<logger level="DEBUG" doc:name="Logger" doc:id="20355e65-1551-4db1-af97-d7b672304c42" message="#[payload]" />
			<set-variable value="#[payload.name]" doc:name="Set Environment Name Variable" doc:id="9c98fecd-b0b8-46fd-a5a4-c4d81329c521"
				variableName="environmentName" />
			<set-variable value="#[payload.id]" doc:name="Set Environment ID Variable" doc:id="89f79ea1-8de9-4516-8984-d4c348df8e53"
				variableName="environmentId" />
			<set-variable value="#[payload.isProduction]" doc:name="Set Environment ID Variable" doc:id="1b4f88b7-d03a-4fff-8e60-8bcf3f0864c1"
						variableName="isProduction" />
			<flow-ref doc:name="Get API Manager APIs Flow Reference" doc:id="11e1602e-2ea0-437a-bec5-dd57f011bfb6" name="api-call-api-manager-apis-flow" />
			<logger level="DEBUG" doc:name="Logger" doc:id="fa4b0ab9-5e90-4305-aaed-c81f6a57d6fe" message="#[payload]" />
			<set-payload value='#[output application/json --- { environment: vars.environmentName, isProduction: vars.isProduction, data: payload}]' doc:name="Aggregate metrics"
				doc:id="cebe5398-ff5f-4492-96f7-84bafdaf1a33" />
		</parallel-foreach>
	</flow>

</mule>
